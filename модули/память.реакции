// // // //

function УлавливатьВыборСфер(мир)
{
    добавитьСловарь(мир.состояние, {
        "номер выбранной сферы": null,
        "номера выбранных сфер": [],
    });
    
    this.исполнить = function()
    {
        мир.состояние["улавливатель"] = new THREE.Raycaster();
        this.отслеживатьНастолки();
        this.отслеживатьМобилки();
    };
    this.отслеживатьНастолки = function()
    {
        var self = this;
        window.addEventListener(
            "click",
            function(событие) {
                var позиция = new THREE.Vector2();
                позиция.x = (событие.clientX / window.innerWidth) * 2 - 1;
                позиция.y = - (событие.clientY / window.innerHeight) * 2 + 1;
                self.выбрать(позиция);
            }
        );
    };
    this.отслеживатьМобилки = function()
    {
        var self = this;
        window.addEventListener(
            "touchstart",
            function(событие) {
                var позиция = new THREE.Vector2();
                позиция.x = (событие.touches[0].clientX / window.innerWidth) * 2 - 1;
                позиция.y = - (событие.touches[0].clientY / window.innerHeight) * 2 + 1;
                self.выбрать(позиция);
            }
        );
        // Исправляем улавливание нажатий на iOS.
        // https://stackoverflow.com/a/31459240/3404710
        var отрисовщик = мир.состояние["отрисовщик"];
        отрисовщик.domElement.style.cursor = "pointer";
    };
    this.выбрать = function(позиция)
    {
        var улавливатель = мир.состояние["улавливатель"];
        var камера = мир.состояние["камера"];
        var корень = мир.состояние["корень"];
        улавливатель.setFromCamera(позиция, камера);
        var пересечения = улавливатель.intersectObjects(корень.children);
        if (пересечения.length)
        {
            var сфера = пересечения[0].object;
            var номер = this.номерСферы(сфера.id);
            if (номер)
            {
                мир.состояние["номер выбранной сферы"] = номер;
                мир.состояние["номера выбранных сфер"].push(номер);
                мир.события["выбор"].уведомить();
            }
        }
    };
    this.номерСферы = function(id)
    {
        var сферы = мир.состояние["сферы"];
        for (var номер in сферы)
        {
            var сфера = сферы[номер];
            if (сфера.id == id)
            {
                return номер;
            }
        }
        
        return null;
    };
}

// // // //

function ЦентрироватьСцену(мир)
{
    this.исполнить = function()
    {
        var корень = мир.состояние["корень"];
        корень.position.set(-1.5, -1.5, 0);
    };
}

// // // //

function ОкраситьЭкран(мир)
{
    this.исполнить = function()
    {
        мир.состояние["сцена"].background.set(0x888888);
    };
}

// // // //

function ПроверитьОкончание(мир)
{
    мир.состояние["скрыто сфер"] = 0;
    this.исполнить = function()
    {
        мир.состояние["скрыто сфер"] += 2;
        var скрыто = мир.состояние["скрыто сфер"];
        var сфер = мир.состояние["сферы"].length;
        if (сфер == скрыто)
        {
            мир.события["конец"].уведомить();
        }
    };
}

// // // //

function СкрытьПару(мир)
{
    this.исполнить = function()
    {
        var пауза = мир.настройки["пауза"];
        var self = this;
        setTimeout(
            function() {
                очиститьМатериалы(мир.состояние);
                self.скрытьВыбранныеСферы();
                мир.состояние["номер выбранной сферы"] = null;
                мир.состояние["номера выбранных сфер"] = [];
            },
            пауза
        );
    };
    this.скрытьВыбранныеСферы = function()
    {
        var номера = мир.состояние["номера выбранных сфер"];
        var сферы = мир.состояние["сферы"];
        for (var н in номера)
        {
            var номер = номера[н];
            var сфера = сферы[номер];
            сфера.visible = false;
        }
    };
}

// // // //

function ОчиститьВыбор(мир)
{
    this.исполнить = function()
    {
        var пауза = мир.настройки["пауза"];
        мир.состояние["номер выбранной сферы"] = null;
        мир.состояние["номера выбранных сфер"] = [];
        
        setTimeout(
            function() {
                очиститьМатериалы(мир.состояние);
            },
            пауза
        );
    };
}

// // // //

function СравнитьПару(мир)
{
    this.исполнить = function()
    {
        var номера = мир.состояние["номера выбранных сфер"];
        var н0 = номера[0];
        var н1 = номера[1];
        
        // Дубль.
        if (н0 == н1)
        {
            мир.события["пара дублируется"].уведомить();
            return;
        }
        
        var группы = мир.состояние["группы"];
        var г0 = группы[н0];
        var г1 = группы[н1];
        
        // Совпадение.
        if (г0 == г1)
        {
            мир.события["пара совпадает"].уведомить();
        }
        // Различие.
        else
        {
            мир.события["пара различается"].уведомить();
        }
    };
}

// // // //

function ВывестиВыбранныеНомераСфер(мир)
{
    this.исполнить = function()
    {
        var номера = мир.состояние["номера выбранных сфер"];
        console.log("Номера выбранных сфер:", номера);
    };
}

// // // //

function ПроверитьВыборПары(мир)
{
    this.исполнить = function()
    {
        var номера = мир.состояние["номера выбранных сфер"];
        if (номера.length == 2)
        {
            мир.события["выбор пары"].уведомить();
        }
    };
}

// // // //

function ОкраситьВыбраннуюСферу(мир)
{
    this.исполнить = function()
    {
        var номер = мир.состояние["номер выбранной сферы"];
        var сферы = мир.состояние["сферы"];
        var сфера = сферы[номер];
        var группы = мир.состояние["группы"];
        var группа = группы[номер];
        var материалы = мир.состояние["материалы"];
        var материал = материалы[группа];
        сфера.material = материал;
    };
}

// // // //

function ЗадатьПаузу(мир)
{
    мир.настройки["пауза"] = 150;
    this.исполнить = function() { };
}

// // // //

function ЗадатьГруппыПоследовательно(мир)
{
    this.исполнить = function()
    {
        var группы = [];
        var сферы = мир.состояние["сферы"];
        for (var номер in сферы)
        {
            var группа = Math.floor(номер / 2);
            группы.push(группа);
        }
        мир.состояние["группы"] = группы;
    };
}

// // // //

function ЗадатьЦветаВыбораСфер(мир)
{
    this.исполнить = function()
    {
        var цвета = [
            0xff0000,
            0x00ff00,
            0x0000ff,
            0xffff00,
            0x00ffff,
            0xff00ff,
            0x888800,
            0x008888,
        ];
        var материалы = [];
        for (var номер in цвета)
        {
            var цвет = цвета[номер];
            var материал = new THREE.MeshLambertMaterial({ color: цвет });
            материалы.push(материал);
            мир.состояние["материалы"] = материалы;
        }
    };
}

// // // //

function ЗадатьСферамНейтральныйЦвет(мир)
{
    this.исполнить = function()
    {
        var нейтраль = new THREE.MeshLambertMaterial();
        мир.состояние["нейтраль"] = нейтраль;
        var сферы = мир.состояние["сферы"];
        for (var номер in сферы)
        {
            var сфера = сферы[номер];
            сфера.material = нейтраль;
        }
    };
}

// // // //

function ВывестиНомерВыбраннойСферы(мир)
{
    this.исполнить = function()
    {
        var номер = мир.состояние["номер выбранной сферы"];
        console.log("Номер выбранной сферы: '" + номер + "'");
    };
}

// // // //

function НастроитьThreeJS(мир)
{
    this.исполнить = function()
    {
        var сцена = new THREE.Scene();
        сцена.background = new THREE.Color(0x333366);
        var камера = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
        var отрисовщик = new THREE.WebGLRenderer();
        document.body.appendChild(отрисовщик.domElement);
        добавитьСловарь(мир.состояние, {
            "сцена": сцена,
            "камера": камера,
            "отрисовщик": отрисовщик,
        });
        
        // Поддержка изменения размера окна.
        var self = this;
        window.addEventListener(
            "resize",
            function() { self.изменитьРазмер(); }
        );
        this.изменитьРазмер();
        
        // Непосредственно отрисовка.
        function отрисовать()
        {   
            requestAnimationFrame(отрисовать);
            отрисовщик.render(сцена, камера);
        }
        отрисовать();
    };
    
    this.изменитьРазмер = function()
    {
        var ширина = window.innerWidth;
        var высота = window.innerHeight;
        var камера = мир.состояние["камера"];
        камера.aspect = ширина / высота;
        камера.updateProjectionMatrix();
        мир.состояние["отрисовщик"].setSize(ширина, высота);
    };
}

// // // //

function ПодготовитьСцену(мир)
{
    this.исполнить = function()
    {
        мир.состояние["камера"].position.z = 10;
        // Создаём источник света.
        var свет = new THREE.DirectionalLight(0xffffff, 1);
        свет.position.set(-0.5, 0.5, 1).normalize();
        var сцена = мир.состояние["сцена"];
        сцена.add(свет);
        // Создаём корень.
        var корень = new THREE.Group();
        сцена.add(корень);
        мир.состояние["корень"] = корень;
    };
}

// // // //

function ОтдалитьКамеру(мир)
{
    this.исполнить = function()
    {
        мир.состояние["камера"].position.z = 30;
    };
}

// // // //

function СоздатьСферы(мир)
{
    мир.состояние["сферы"] = [];
    
    this.исполнить = function()
    {
        var сферы = мир.состояние["сферы"];
        var количество = 16;
        var форма = new THREE.SphereBufferGeometry(0.4, 32, 32);
        var корень = мир.состояние["корень"];
        for (var номер = 0; номер < количество; ++номер)
        {
            var сфера = new THREE.Mesh(форма);
            корень.add(сфера);
            сферы.push(сфера);
        }
    };
}

// // // //

function РасположитьСферыВСетке(мир)
{
    this.исполнить = function()
    {
        var позиции = [
            [0, 0, 0],
            [1, 0, 0],
            [2, 0, 0],
            [3, 0, 0],
            [0, 1, 0],
            [1, 1, 0],
            [2, 1, 0],
            [3, 1, 0],
            [0, 2, 0],
            [1, 2, 0],
            [2, 2, 0],
            [3, 2, 0],
            [0, 3, 0],
            [1, 3, 0],
            [2, 3, 0],
            [3, 3, 0],
        ];
        var сферы = мир.состояние["сферы"];
        
        for (var номер in позиции)
        {
            var сфера = сферы[номер];
            var п = позиции[номер];
            сфера.position.set(п[0], п[1], п[2]);
        }
    };
}